<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>KDSEVEN CLOUD WEB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #050816;
      color: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      /* Fundo com imagem + gradiente escuro por cima */
      background:
        radial-gradient(circle at top, rgba(15,23,42,0.9) 0, #020617 55%),
        url("https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1600&q=80")
          center/cover fixed no-repeat;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: rgba(15, 23, 42, 0.92);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.85);
      padding: 20px 22px 26px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(18px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      padding-bottom: 12px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title span.logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #22c55e 0, #22c55e 40%, #0ea5e9 100%);
      color: #020617;
      font-weight: 900;
      font-size: 14px;
      box-shadow: 0 0 22px rgba(34, 197, 94, 0.6);
    }

    .subtitle {
      font-size: 12px;
      color: #9ca3af;
    }

    .status-pill {
      font-size: 12px;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.1);
      color: #4ade80;
      border: 1px solid rgba(22, 163, 74, 0.5);
    }

    .grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      padding: 14px 14px 16px;
      position: relative;
      overflow: hidden;
    }

    /* Background bonito no card de login */
    #login-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        linear-gradient(135deg, rgba(15,23,42,0.9), rgba(8,47,73,0.8)),
        url("https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1600&q=80")
          center/cover no-repeat;
      opacity: 0.35;
      z-index: -1;
      filter: blur(1px);
      transform: scale(1.02);
    }

    .card h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .card h2 span.right-label {
      font-size: 11px;
      color: #e5e7eb;
      text-transform: none;
      letter-spacing: normal;
    }

    label {
      display: block;
      font-size: 12px;
      color: #d1d5db;
      margin-bottom: 4px;
    }

    input, select, textarea {
      width: 100%;
      background-color: rgba(2, 6, 23, 0.92);
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 7px 9px;
      font-size: 13px;
      color: #e5e7eb;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
      background-color: #020617;
    }

    input[readonly] {
      opacity: 0.8;
      cursor: default;
    }

    textarea {
      min-height: 200px;
      resize: vertical;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre;
    }

    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .row > div {
      flex: 1;
      min-width: 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      background: linear-gradient(to right, #22c55e, #0ea5e9);
      color: #020617;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 14px 30px rgba(34, 197, 94, 0.55);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(34, 197, 94, 0.35);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: #e5e7eb;
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.7);
    }

    .btn-small {
      padding: 5px 9px;
      font-size: 11px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.8);
      font-size: 11px;
      color: #9ca3af;
    }

    .badge span.value {
      color: #f97316;
      font-weight: 600;
    }

    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .mode-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .mode-tab {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #9ca3af;
      cursor: pointer;
      user-select: none;
      transition: all 0.12s ease;
    }

    .mode-tab.active {
      border-color: #22c55e;
      color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.4);
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #9ca3af;
    }

    .checkbox-row input[type="checkbox"] {
      width: auto;
      margin: 0;
      transform: translateY(1px);
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 11px;
      color: #9ca3af;
    }

    .results-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .muted {
      color: #d1d5db;
      font-size: 11px;
    }

    .highlight {
      color: #22c55e;
      font-weight: 600;
    }

    .pix-qr {
      margin-top: 10px;
      text-align: center;
    }

    .pix-qr img {
      max-width: 210px;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      padding: 6px;
    }

    .pix-code {
      margin-top: 8px;
      font-size: 11px;
      background: #020617;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 6px 8px;
      max-height: 80px;
      overflow: auto;
      word-break: break-all;
      text-align: left;
    }

    .footer {
      margin-top: 12px;
      font-size: 10px;
      color: #4b5563;
      text-align: right;
    }

    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      min-width: 180px;
      max-width: 320px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.98);
      color: #e5e7eb;
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.9);
      display: none;
      z-index: 9999;
    }

    .toast.show {
      display: block;
      animation: fadeSlideIn 0.18s ease-out;
    }

    .toast.success {
      border-color: rgba(7, 46, 21, 0.85);
    }

    .toast.error {
      border-color: rgba(239, 68, 68, 0.85);
    }

    .toast .title {
      font-size: 12px;
      margin: 0 0 4px;
    }

    .toast .message {
      font-size: 11px;
      color: #9ca3af;
    }

    @keyframes fadeSlideIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Estado visual quando logado */
    #login-card.logged-in input#token-input {
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">
          <span class="logo">‚Ç≠d‚Ç∏</span>
          ùöÇùöÜùô∏ùôµùöÉùöÇùô¥ùô¥ùô∫üîêùôªùô¥ùô∞ùô∫ùöÇ
        </div>
        <div class="subtitle">üíª Ôº≥Ôº©Ôº≥Ôº¥Ôº•Ôº≠Ôº°„ÄÄÔº§Ôº•Ôº≥Ôº•ÔºÆÔº∂ÔºØÔº¨Ôº∂Ôº©Ôº§ÔºØ„ÄÄÔº∞Ôº•Ôº¨Ôº°„ÄÄÔº´Ôº§Ôº≥Ôº•Ôº∂Ôº•ÔºÆ„ÄÄÔº≥Ôº•Ôº≤Ôº∂Ôº©Ôº£Ôº•Ôº≥</div>
      </div>
      <div class="status-pill">Status: <span id="api-status-text">aguardando teste‚Ä¶</span></div>
    </div>

    <!-- LOGIN POR TOKEN + COMPRA DE TOKEN (PIX) -->
    <div class="card" id="login-card">
      <h2>
        Acesso por Token
        <span class="right-label" id="login-status-label">Insira seu token para entrar</span>
      </h2>

      <div class="row">
        <div>
          <label>Token de acesso</label>
          <input type="text" id="token-input" placeholder="Cole aqui o token recebido ap√≥s a compra" />
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn" id="btn-login-token">Entrar no painel</button>
        </div>
      </div>

      <div class="muted" style="margin-bottom:10px;">
        Seu token √© √∫nico, vinculado ao seu saldo e s√≥ pode estar ativo em <span class="highlight">1 IP por vez</span>.
      </div>

      <hr style="border-color: rgba(31, 41, 55, 0.9); margin: 10px 0;" />

      <h2 style="margin-top:0;">
        Ainda n√£o tem token?
        <span class="right-label">Compre saldo e receba o token automaticamente</span>
      </h2>

      <div class="row">
        <div>
          <label>Nickname / identifica√ß√£o</label>
          <input type="text" id="phone" placeholder="Ex: seu_nick_unico" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Valor da recarga (R$)</label>
          <input type="number" min="20" step="1" id="pix-amount" placeholder="Ex: 50" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:6px;">
          <button class="btn" id="btn-create-pix">Gerar PIX</button>
        </div>
      </div>

      <div class="muted">
        Ap√≥s o pagamento ser confirmado, clique em <span class="highlight">Verificar pagamento</span> e o sistema
        gera / retorna automaticamente um <span class="highlight">TOKEN √öNICO</span> vinculado ao seu saldo.
        <br />Copie esse token e guarde em um local seguro.
      </div>

      <div class="pix-qr" id="pix-qr-container" style="display:none;">
        <div class="muted" style="margin-bottom:4px;">Escaneie o QR Code ou copie o c√≥digo PIX abaixo.</div>
        <img id="pix-qr-img" alt="QR Code PIX" />
        <div class="pix-code" id="pix-code"></div>
        <div style="margin-top:8px; display:flex; justify-content:center; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-small btn-secondary" id="btn-copy-pix">Copiar c√≥digo PIX</button>
          <button class="btn btn-small" id="btn-check-pix">Verificar pagamento</button>
        </div>
        <div class="muted" id="pix-status-text" style="margin-top:6px;"></div>
        <div class="muted" id="token-created-text" style="margin-top:6px; display:none;"></div>
      </div>
    </div>

    <!-- PAINEL PRINCIPAL (SOMENTE AP√ìS LOGIN POR TOKEN) -->
    <div class="grid" id="main-grid" style="display:none; margin-top:14px;">
      <!-- LADO ESQUERDO: INFO DA CONTA/TOKEN -->
      <div class="card">
        <h2>
          Conta & Token
          <span class="right-label" id="token-label"></span>
        </h2>

        <div class="row">
          <div>
            <label>Token logado</label>
            <input type="text" id="token-logged" readonly />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Nickname vinculado</label>
            <input type="text" id="phone-linked" readonly />
          </div>
        </div>

        <div class="row" style="margin-bottom: 6px;">
          <button class="btn" id="btn-load-saldo">Atualizar saldo</button>
          <button class="btn btn-secondary" id="btn-logout">Sair</button>
          <button class="btn btn-secondary" id="btn-test-api">Testar API</button>
        </div>

        <div class="row" style="margin-bottom: 8px;">
          <div class="badge">
            <span class="dot"></span>
            Cr√©ditos:
            <span class="value" id="credits-value">--</span>
          </div>
          <div class="badge" id="rental-info">
            Aluguel: <span class="value" id="rental-status">nenhum ativo</span>
          </div>
        </div>
      </div>

      <!-- LADO DIREITO: BUSCAS -->
      <div class="card">
        <h2>
          Buscas & Resultados
          <span class="right-label" id="stats-label"></span>
        </h2>

        <div class="mode-tabs">
          <div class="mode-tab active" data-mode="NORMAL">Normal</div>
          <div class="mode-tab" data-mode="ANDROID">Android</div>
          <div class="mode-tab" data-mode="PREMIUM">Premium (todas bases)</div>
          <div class="mode-tab" data-mode="MIX">Mix 20K aleat√≥rio</div>
        </div>

        <div id="search-fields">
          <div class="row">
            <div>
              <label>Palavra-chave / termo</label>
              <input type="text" id="keyword" placeholder="Ex: gmail.com, nome, dom√≠nio, etc." />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Plano</label>
              <select id="plano">
                <option value="NORMAL">NORMAL</option>
                <option value="SIMPLES">SIMPLES</option>
                <option value="INTERMEDIARIO">INTERMEDIARIO</option>
                <option value="MASTER">MASTER</option>
                <option value="AVANCADO">AVANCADO</option>
                <option value="ADMINISTRATIVA">ADMINISTRATIVA</option>
              </select>
            </div>
            <div>
              <label>Formato do resultado</label>
              <select id="format">
                <option value="full">Completo (linha inteira)</option>
                <option value="user">user:pass (tentativa)</option>
              </select>
            </div>
          </div>

          <div class="row" style="align-items:center; margin-bottom:8px;">
            <div class="checkbox-row">
              <input type="checkbox" id="use-rental" />
              <span>ATIVE CASO QUEIRA USAR NA DIARIA! (CUSTO 50 CREDITOS!)</span>
            </div>
          </div>
        </div>

        <div class="row" style="margin-bottom:10px;">
          <button class="btn" id="btn-search">
            Executar busca
          </button>
          <button class="btn btn-secondary btn-small" id="btn-mix-direct" style="display:none;">
            Rodar Mix 20K
          </button>
        </div>

        <div class="results-header">
          <div>
            <span class="muted">Resultados:</span>
            <span class="highlight" id="results-count">0 linhas</span>
          </div>
          <div class="results-actions">
            <button class="btn-secondary btn-small" id="btn-copy-results">Copiar</button>
            <button class="btn-secondary btn-small" id="btn-download-results">Baixar .txt</button>
          </div>
        </div>

        <textarea id="results" placeholder="Os resultados das buscas aparecer√£o aqui..." readonly></textarea>
      </div>
    </div>

    <div class="footer">
      KDSEVEN ‚Ä¢ MELHOR SISTEMA DE ULP SEARCH.
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="title" id="toast-title"></div>
    <div class="message" id="toast-message"></div>
  </div>

  <script>
    const API_BASE = (window.location.origin.startsWith("file://"))
        ? "http://localhost:3000"
        : window.location.origin;

    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    let currentToken = null;

    function showToast(title, message, type = "success") {
      toastEl.className = "toast show " + type;
      $("toast-title").textContent = title;
      $("toast-message").textContent = message;
      setTimeout(() => {
        toastEl.classList.remove("show");
      }, 3500);
    }

    function setApiStatus(text, ok = true) {
      const el = $("api-status-text");
      el.textContent = text;
      const pill = document.querySelector(".status-pill");
      if (ok) {
        pill.style.background = "rgba(22,163,74,0.1)";
        pill.style.color = "#4ade80";
        pill.style.borderColor = "rgba(22,163,74,0.5)";
      } else {
        pill.style.background = "rgba(239,68,68,0.08)";
        pill.style.color = "#fca5a5";
        pill.style.borderColor = "rgba(239,68,68,0.6)";
      }
    }

    function handleAuthError(data) {
      const msg = (data && data.error) ? data.error : "Sess√£o expirada ou token inv√°lido.";
      currentToken = null;
      localStorage.removeItem("kd_token");
      $("main-grid").style.display = "none";
      $("login-status-label").textContent = "Insira seu token para entrar";
      $("login-card").classList.remove("logged-in");
      $("token-logged").value = "";
      $("phone-linked").value = "";
      $("token-label").textContent = "";
      const rentalCheckbox = $("use-rental");
      const rentalLabel = document.querySelector(".checkbox-row span");
      if (rentalCheckbox) {
        rentalCheckbox.checked = false;
        rentalCheckbox.disabled = false;
      }
      if (rentalLabel) {
        rentalLabel.textContent = "Usar cr√©ditos de aluguel (se tiver ativo)";
      }
      $("rental-status").textContent = "nenhum ativo";
      showToast("Sess√£o finalizada", msg, "error");
    }

    async function apiGet(path, auth = false) {
      const headers = {};
      if (auth && currentToken) {
        headers["x-auth-token"] = currentToken;
      }
      const res = await fetch(API_BASE + path, { method: "GET", headers });
      let data;
      try {
        data = await res.json();
      } catch {
        data = {};
      }
      if (res.status === 401 || res.status === 403) {
        handleAuthError(data);
      }
      return data;
    }

    async function apiPost(path, body, auth = false) {
      const headers = {
        "Content-Type": "application/json",
      };
      if (auth && currentToken) {
        headers["x-auth-token"] = currentToken;
      }
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers,
        body: JSON.stringify(body || {}),
      });
      let data;
      try {
        data = await res.json();
      } catch {
        data = {};
      }
      if (res.status === 401 || res.status === 403) {
        handleAuthError(data);
      }
      return data;
    }

    function updateStatsLabel(stats) {
      if (!stats) {
        $("stats-label").textContent = "";
        return;
      }
      const parts = [];
      if (stats.plano) parts.push("Plano: " + stats.plano);
      if (stats.linhas !== undefined) parts.push("Linhas: " + stats.linhas);
      if (stats.tempoSegundos) parts.push("Tempo: " + stats.tempoSegundos + "s");
      if (stats.custo !== undefined) parts.push("Custo: " + stats.custo);
      if (stats.credits !== undefined) parts.push("Cr√©ditos: " + stats.credits);
      $("stats-label").textContent = parts.join(" ‚Ä¢ ");
    }

    function setResults(list) {
      const lines = Array.isArray(list) ? list : [];
      $("results").value = lines.join("\n");
      $("results-count").textContent = `${lines.length} linha(s)`;
    }

    function downloadTextFile(filename, content) {
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function copyToClipboard(text) {
      if (!text) return;
      navigator.clipboard.writeText(text).then(
        () => showToast("Copiado", "Conte√∫do copiado para a √°rea de transfer√™ncia."),
        () => showToast("Falha", "N√£o foi poss√≠vel copiar.", "error")
      );
    }

    function setMode(mode) {
      const tabs = document.querySelectorAll(".mode-tab");
      tabs.forEach((tab) => {
        if (tab.dataset.mode === mode) tab.classList.add("active");
        else tab.classList.remove("active");
      });

      const fields = $("search-fields");
      const mixBtn = $("btn-mix-direct");
      const formatSelect = $("format");
      const planoSelect = $("plano");
      const keywordInput = $("keyword");
      const rentalCheck = $("use-rental");

      if (mode === "MIX") {
        fields.style.display = "none";
        mixBtn.style.display = "inline-flex";
      } else {
        fields.style.display = "block";
        mixBtn.style.display = "none";
      }

      if (mode === "PREMIUM") {
        planoSelect.disabled = true;
        formatSelect.disabled = true;
        rentalCheck.disabled = rentalCheck.disabled; // n√£o mexe no estado de ativa√ß√£o do aluguel
        keywordInput.disabled = false;
      } else if (mode === "MIX") {
        keywordInput.disabled = true;
        planoSelect.disabled = true;
        formatSelect.disabled = true;
        rentalCheck.disabled = rentalCheck.disabled; // idem
      } else {
        planoSelect.disabled = false;
        formatSelect.disabled = false;
        keywordInput.disabled = false;
        // rentalCheck habilita/desabilita de acordo com aluguel ativo, controlado em setLoggedIn/loadSaldo
      }

      updateStatsLabel(null);
      setResults([]);
    }

    function setLoggedIn(token, info) {
      currentToken = token;
      localStorage.setItem("kd_token", token);

      $("main-grid").style.display = "grid";
      $("login-card").classList.add("logged-in");
      $("login-status-label").textContent = "Logado com token";

      $("token-logged").value = token;
      $("token-input").value = token;

      const maskedToken = token.length > 8
        ? token.slice(0, 4) + "..." + token.slice(-4)
        : token;
      $("token-label").textContent = "Token: " + maskedToken;

      $("phone-linked").value = info.phone || "";
      $("credits-value").textContent = info.credits ?? "--";

      const rentalCheckbox = $("use-rental");
      const rentalLabel = document.querySelector(".checkbox-row span");

      if (info.rental) {
        $("rental-status").textContent =
          `${info.rental.plan} ‚Ä¢ ${info.rental.usedToday}/${info.rental.dailyLimit} hoje ‚Ä¢ expira em ` +
          new Date(info.rental.expires).toLocaleString("pt-BR");
        if (rentalCheckbox) {
          rentalCheckbox.checked = true;
          // aluguel di√°rio fica sempre ativo enquanto durar (24h)
          rentalCheckbox.disabled = true;
        }
        if (rentalLabel) {
          rentalLabel.textContent = "Aluguel di√°rio ativo (consome buscas sem gastar cr√©ditos por 24h)";
        }
      } else {
        $("rental-status").textContent = "nenhum ativo";
        if (rentalCheckbox) {
          rentalCheckbox.checked = false;
          rentalCheckbox.disabled = false;
        }
        if (rentalLabel) {
          rentalLabel.textContent = "Usar cr√©ditos de aluguel (se tiver ativo)";
        }
      }

      showToast("Bem-vindo", "Login por token realizado com sucesso.");
    }

    function logout(reason) {
      currentToken = null;
      localStorage.removeItem("kd_token");
      $("main-grid").style.display = "none";
      $("login-card").classList.remove("logged-in");
      $("login-status-label").textContent = "Insira seu token para entrar";
      $("token-logged").value = "";
      $("phone-linked").value = "";
      $("token-label").textContent = "";
      $("credits-value").textContent = "--";
      $("rental-status").textContent = "nenhum ativo";

      const rentalCheckbox = $("use-rental");
      const rentalLabel = document.querySelector(".checkbox-row span");
      if (rentalCheckbox) {
        rentalCheckbox.checked = false;
        rentalCheckbox.disabled = false;
      }
      if (rentalLabel) {
        rentalLabel.textContent = "Usar cr√©ditos de aluguel (se tiver ativo)";
      }

      updateStatsLabel(null);
      setResults([]);
      if (reason) {
        showToast("Sess√£o encerrada", reason, "success");
      }
    }

    async function loadSaldo() {
      if (!currentToken) {
        showToast("Aten√ß√£o", "Fa√ßa login com seu token antes.", "error");
        return;
      }

      try {
        const data = await apiGet("/api/saldo", true);
        if (!data.ok) {
          showToast("Erro", data.error || "Falha ao buscar saldo.", "error");
          return;
        }

        $("phone-linked").value = data.phone || "";
        $("credits-value").textContent = data.credits;

        const rentalCheckbox = $("use-rental");
        const rentalLabel = document.querySelector(".checkbox-row span");

        if (data.rental) {
          $("rental-status").textContent =
            `${data.rental.plan} ‚Ä¢ ${data.rental.usedToday}/${data.rental.dailyLimit} hoje ‚Ä¢ expira em ` +
            new Date(data.rental.expires).toLocaleString("pt-BR");
          if (rentalCheckbox) {
            rentalCheckbox.checked = true;
            rentalCheckbox.disabled = true;
          }
          if (rentalLabel) {
            rentalLabel.textContent = "Aluguel di√°rio ativo (consome buscas sem gastar cr√©ditos por 24h)";
          }
        } else {
          $("rental-status").textContent = "nenhum ativo";
          if (rentalCheckbox) {
            rentalCheckbox.checked = false;
            rentalCheckbox.disabled = false;
          }
          if (rentalLabel) {
            rentalLabel.textContent = "Usar cr√©ditos de aluguel (se tiver ativo)";
          }
        }

        showToast("Saldo atualizado", `Cr√©ditos: ${data.credits}`);
      } catch (e) {
        console.error(e);
        showToast("Erro", "N√£o foi poss√≠vel conectar √† API.", "error");
        setApiStatus("offline", false);
      }
    }

    async function testApi() {
      try {
        const r = await fetch(API_BASE + "/");
        if (!r.ok) throw new Error("Status " + r.status);
        setApiStatus("online");
        showToast("API OK", "Servidor Web est√° respondendo.");
      } catch (e) {
        console.error(e);
        setApiStatus("offline", false);
        showToast("API offline", "Verifique se o web-kdseven.js est√° rodando na porta 3000.", "error");
      }
    }

    async function executarBusca(isMixDirect = false) {
      if (!currentToken) {
        showToast("Aten√ß√£o", "Fa√ßa login com seu token antes de buscar.", "error");
        return;
      }

      const activeTab = document.querySelector(".mode-tab.active");
      const mode = activeTab ? activeTab.dataset.mode : "NORMAL";

      let keyword = $("keyword").value.trim();
      const plano = $("plano").value;
      const format = $("format").value;
      const isRental = $("use-rental").checked;

      try {
        $("btn-search").disabled = true;
        $("btn-search").textContent = "Buscando...";

        let resp;
        if (mode === "MIX" || isMixDirect) {
          resp = await apiPost("/api/search/mix", {}, true);
        } else if (mode === "PREMIUM") {
          if (!keyword) {
            showToast("Aten√ß√£o", "Informe a palavra-chave para busca Premium.", "error");
            return;
          }
          resp = await apiPost("/api/search/premium", { keyword }, true);
        } else {
          if (!keyword) {
            showToast("Aten√ß√£o", "Informe a palavra-chave para a busca.", "error");
            return;
          }
          const searchType = mode === "ANDROID" ? "ANDROID" : "NORMAL";
          resp = await apiPost(
            "/api/search",
            { keyword, plano, searchType, format, isRental },
            true
          );
        }

        if (!resp.ok) {
          showToast("Erro", resp.error || "Falha ao executar busca.", "error");
          updateStatsLabel(null);
          setResults([]);
          return;
        }

        const results = resp.results || [];
        setResults(results);
        updateStatsLabel(resp.stats);

        if (resp.stats && resp.stats.credits !== undefined) {
          $("credits-value").textContent = resp.stats.credits;
        } else {
          loadSaldo();
        }

        const label =
          mode === "PREMIUM"
            ? "Busca Premium completa."
            : mode === "MIX"
            ? "Mix 20K executado."
            : "Busca finalizada.";
        showToast("OK", `${label} Encontradas ${results.length} linha(s).`);
      } catch (e) {
        console.error(e);
        showToast("Erro", "N√£o foi poss√≠vel executar a busca.", "error");
      } finally {
        $("btn-search").disabled = false;
        $("btn-search").textContent = "Executar busca";
      }
    }

    async function criarPix() {
      const phone = $("phone").value.trim(); // aqui √© o NICKNAME, s√≥ reaproveitando a vari√°vel
      if (!phone) {
        showToast("Aten√ß√£o", "Informe um nickname antes de gerar PIX.", "error");
        return;
      }
      const rawAmount = $("pix-amount").value.trim();
      if (!rawAmount) {
        showToast("Aten√ß√£o", "Informe o valor da recarga.", "error");
        return;
      }

      const amount = parseFloat(rawAmount.replace(",", "."));
      if (isNaN(amount) || amount < 20) {
        showToast("Aten√ß√£o", "Valor m√≠nimo para recarga √© R$ 20,00.", "error");
        return;
      }

      try {
        $("btn-create-pix").disabled = true;
        $("btn-create-pix").textContent = "Gerando PIX...";

        const resp = await apiPost("/api/pix/create", { phone, amount }, false);
        if (!resp.ok) {
          showToast("Erro", resp.error || "Falha ao gerar PIX.", "error");
          return;
        }

        const { txid, qrcode, imagemQrcode } = resp;
        $("pix-qr-container").style.display = "block";
        $("pix-code").textContent = qrcode || "";
        $("pix-qr-img").src = imagemQrcode || "";
        $("pix-status-text").textContent = "TXID: " + txid + " (aguardando pagamento...)";
        $("pix-qr-container").dataset.txid = txid;
        $("token-created-text").style.display = "none";
        $("token-created-text").textContent = "";

        showToast("PIX criado", "Escaneie o QR Code ou copie o c√≥digo PIX.");
      } catch (e) {
        console.error(e);
        showToast("Erro", "N√£o foi poss√≠vel criar o PIX.", "error");
      } finally {
        $("btn-create-pix").disabled = false;
        $("btn-create-pix").textContent = "Gerar PIX";
      }
    }

    async function verificarPix() {
      const txid = $("pix-qr-container").dataset.txid;
      if (!txid) {
        showToast("Aten√ß√£o", "Nenhum PIX em aberto para verificar.", "error");
        return;
      }

      try {
        $("btn-check-pix").disabled = true;
        $("btn-check-pix").textContent = "Verificando...";

        const resp = await apiGet("/api/pix/status/" + encodeURIComponent(txid), false);
        if (!resp.ok) {
          showToast("Erro", resp.error || "Falha ao verificar PIX.", "error");
          return;
        }

        const status = resp.status || resp.detalhes?.status || "DESCONHECIDO";
        $("pix-status-text").textContent = "Status do PIX: " + status;

        if (status === "CONCLUIDA") {
          showToast("Pagamento confirmado", "Cr√©ditos liberados. Seu token foi gerado/vinculado.");
          const token = resp.token;
          if (token) {
            $("token-created-text").style.display = "block";
            $("token-created-text").textContent =
              "TOKEN GERADO PARA ESTE NICKNAME: " + token + " (copie e guarde em local seguro)";
            $("token-input").value = token;
          }
        } else if (status === "REMOVIDA_PELO_USUARIO_RECEBEDOR" || status === "REMOVIDA_PELO_PSP") {
          showToast("PIX expirado/cancelado", "Gere um novo PIX se quiser tentar novamente.", "error");
        } else {
          showToast("Status", "Status atual: " + status);
        }
      } catch (e) {
        console.error(e);
        showToast("Erro", "N√£o foi poss√≠vel verificar o PIX.", "error");
      } finally {
        $("btn-check-pix").disabled = false;
        $("btn-check-pix").textContent = "Verificar pagamento";
      }
    }

    async function loginWithToken() {
      const token = $("token-input").value.trim();
      if (!token) {
        showToast("Aten√ß√£o", "Informe o token de acesso.", "error");
        return;
      }

      try {
        $("btn-login-token").disabled = true;
        $("btn-login-token").textContent = "Entrando...";

        currentToken = token; // temporariamente para o header
        const resp = await apiPost("/api/token/login", {}, true);

        if (!resp || !resp.ok) {
          currentToken = null;
          localStorage.removeItem("kd_token");
          const msg = (resp && resp.error) ? resp.error : "Token inv√°lido ou bloqueado.";
          showToast("Erro", msg, "error");
          $("login-status-label").textContent = "Falha ao logar com o token";
          return;
        }

        setLoggedIn(token, resp);
      } catch (e) {
        console.error(e);
        currentToken = null;
        localStorage.removeItem("kd_token");
        showToast("Erro", "N√£o foi poss√≠vel validar o token.", "error");
      } finally {
        $("btn-login-token").disabled = false;
        $("btn-login-token").textContent = "Entrar no painel";
      }
    }

    async function autoLoginFromStorage() {
      const saved = localStorage.getItem("kd_token");
      if (!saved) return;
      currentToken = saved;
      try {
        const resp = await apiPost("/api/token/login", {}, true);
        if (!resp || !resp.ok) {
          currentToken = null;
          localStorage.removeItem("kd_token");
          return;
        }
        setLoggedIn(saved, resp);
      } catch {
        currentToken = null;
        localStorage.removeItem("kd_token");
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      const tabs = document.querySelectorAll(".mode-tab");
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const mode = tab.dataset.mode;
          setMode(mode);
        });
      });

      $("btn-load-saldo").addEventListener("click", loadSaldo);
      $("btn-test-api").addEventListener("click", testApi);
      $("btn-logout").addEventListener("click", () => logout("Logout realizado."));

      $("btn-search").addEventListener("click", () => executarBusca(false));
      $("btn-mix-direct").addEventListener("click", () => executarBusca(true));

      $("btn-copy-results").addEventListener("click", () => {
        const text = $("results").value;
        if (!text.trim()) {
          showToast("Aten√ß√£o", "N√£o h√° resultados para copiar.", "error");
          return;
        }
        copyToClipboard(text);
      });

      $("btn-download-results").addEventListener("click", () => {
        const text = $("results").value;
        if (!text.trim()) {
          showToast("Aten√ß√£o", "N√£o h√° resultados para baixar.", "error");
          return;
        }
        const token = $("token-logged").value.trim() || "sem_token";
        const keyword = $("keyword").value.trim().replace(/\W+/g, "_") || "busca";
        const filename = `resultado_${token}_${keyword}.txt`;
        downloadTextFile(filename, text);
        showToast("Download", "Arquivo .txt gerado com sucesso.");
      });

      $("btn-create-pix").addEventListener("click", criarPix);
      $("btn-check-pix").addEventListener("click", verificarPix);

      $("btn-copy-pix").addEventListener("click", () => {
        const text = $("pix-code").textContent.trim();
        if (!text) {
          showToast("Aten√ß√£o", "Nenhum c√≥digo PIX para copiar.", "error");
          return;
        }
        copyToClipboard(text);
      });

      $("btn-login-token").addEventListener("click", loginWithToken);

      // Enter para login no campo de token
      $("token-input").addEventListener("keyup", (ev) => {
        if (ev.key === "Enter") {
          loginWithToken();
        }
      });

      testApi();
      autoLoginFromStorage();
    });
  </script>
</body>
</html>
